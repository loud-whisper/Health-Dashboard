<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="HealthDash" />
    <meta name="theme-color" content="#0a0c10" />
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon-512.png" />
    <title>Health Dashboard</title>
    <meta name="description" content="Private, offline health & fitness dashboard for your phone." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --bg: #0a0c10;
            --card: #12151c;
            --card2: #1a1e2a;
            --accent: #00e5ff;
            --accent2: #a78bfa;
            --accent3: #4ade80;
            --accent4: #fb923c;
            --accent5: #f472b6;
            --danger: #f87171;
            --text: #e2e8f0;
            --muted: #64748b;
            --border: #1e2433;
            --r: 12px;
            --glow: 0 0 16px rgba(0, 229, 255, .06);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            background: var(--bg);
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, sans-serif;
            min-height: 100dvh;
            padding: 12px;
            padding-top: calc(12px + var(--safe-top));
            padding-bottom: calc(12px + var(--safe-bottom));
            -webkit-text-size-adjust: 100%;
            overflow-x: hidden;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), var(--accent2), var(--accent5));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 2px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--muted);
            font-size: 0.72rem;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        /* ‚îÄ‚îÄ Section Headers ‚îÄ‚îÄ */
        h2 {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
            margin: 20px 0 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }

        h2::after {
            content: '‚ñæ';
            font-size: 0.65rem;
            margin-left: auto;
            color: var(--muted);
            transition: transform .2s;
        }

        h2.collapsed::after {
            transform: rotate(-90deg);
        }

        .section-body {
            overflow: hidden;
            transition: max-height .3s ease;
        }

        .section-body.collapsed {
            max-height: 0 !important;
        }

        /* ‚îÄ‚îÄ Upload Area ‚îÄ‚îÄ */
        .upload-area {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 14px;
            margin-bottom: 16px;
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        @media (orientation: landscape) {
            .upload-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .uc {
            background: var(--card2);
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-height: 80px;
            cursor: pointer;
            transition: border-color .2s;
        }

        .uc:active {
            border-color: var(--accent);
            transform: scale(0.98);
        }

        .uc.loaded {
            border-color: var(--accent3);
            border-style: solid;
        }

        .uc label {
            font-size: 0.62rem;
            text-transform: uppercase;
            letter-spacing: .06em;
            color: var(--muted);
            font-weight: 600;
            pointer-events: none;
        }

        .uc .fn {
            font-size: 0.65rem;
            color: var(--accent3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            pointer-events: none;
        }

        .uc input[type=file] {
            display: none;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: linear-gradient(135deg, #1e40af, #6d28d9);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.72rem;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            min-height: 36px;
            transition: all .2s;
        }

        .btn:active {
            opacity: .8;
            transform: scale(0.97);
        }

        .action-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-go {
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            color: #000;
            font-weight: 700;
            padding: 14px 24px;
            font-size: 0.9rem;
            border-radius: 12px;
            width: 100%;
            min-height: 50px;
        }

        #status-bar {
            width: 100%;
            background: var(--card2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.7rem;
            color: var(--muted);
            display: none;
            margin-top: 8px;
        }

        /* ‚îÄ‚îÄ Range Bar ‚îÄ‚îÄ */
        .range-bar {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .range-btn {
            background: var(--card2);
            border: 1px solid var(--border);
            border-radius: 18px;
            color: var(--muted);
            padding: 6px 14px;
            font-size: 0.7rem;
            cursor: pointer;
            font-family: inherit;
            min-height: 32px;
            transition: all .15s;
        }

        .range-btn:active {
            transform: scale(0.95);
        }

        .range-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ Stats ‚îÄ‚îÄ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 14px;
        }

        @media (orientation: landscape) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 12px;
        }

        .stat-card .s-lbl {
            font-size: 0.6rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .05em;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .stat-card .s-val {
            font-size: 1.4rem;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -0.02em;
        }

        .stat-card .s-unit {
            font-size: 0.62rem;
            color: var(--muted);
            margin-top: 2px;
        }

        .stat-card .s-sub {
            font-size: 0.62rem;
            color: var(--muted);
            margin-top: 4px;
        }

        .pos {
            color: #4ade80;
        }

        .neg {
            color: #f87171;
        }

        /* ‚îÄ‚îÄ Charts ‚îÄ‚îÄ */
        .charts-grid {
            display: grid;
            gap: 10px;
            grid-template-columns: 1fr;
        }

        @media (orientation: landscape) {
            .charts-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 12px;
            position: relative;
        }

        .chart-card.wide {
            grid-column: 1/-1;
        }

        .chart-card h3 {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }

        .chart-card canvas {
            width: 100% !important;
            max-height: 200px !important;
        }

        @media (orientation: landscape) {
            .chart-card canvas {
                max-height: 180px !important;
            }
        }

        /* ‚îÄ‚îÄ Strength ‚îÄ‚îÄ */
        .strength-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .s-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--r);
            padding: 10px 12px;
            flex: 1 1 calc(50% - 4px);
            min-width: 0;
        }

        @media (orientation: landscape) {
            .s-card {
                flex: 1 1 calc(25% - 6px);
            }
        }

        .s-card .ex-name {
            font-size: 0.58rem;
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .s-card .ex-max {
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1;
        }

        .s-card .ex-unit {
            font-size: 0.6rem;
            color: var(--muted);
        }

        .s-card .ex-meta {
            font-size: 0.58rem;
            color: var(--muted);
            margin-top: 4px;
            line-height: 1.5;
        }

        .ex-header {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .ex-header span {
            font-size: 0.68rem;
            color: var(--muted);
        }

        .ex-clear {
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--muted);
            padding: 4px 10px;
            font-size: 0.65rem;
            cursor: pointer;
            font-family: inherit;
            min-height: 28px;
        }

        .ex-clear:active {
            border-color: var(--danger);
            color: var(--danger);
        }

        .ex-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
            max-height: 120px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 2px;
        }

        .ex-btn {
            background: var(--card2);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--muted);
            padding: 5px 11px;
            font-size: 0.65rem;
            cursor: pointer;
            white-space: nowrap;
            font-family: inherit;
            min-height: 28px;
            transition: all .12s;
        }

        .ex-btn:active {
            transform: scale(0.95);
        }

        .ex-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .empty-hint {
            text-align: center;
            padding: 30px 16px;
            color: var(--muted);
            font-size: 0.8rem;
        }

        .empty-hint .icon {
            font-size: 2rem;
            margin-bottom: 6px;
        }

        /* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>üìä Health Dashboard</h1>
    <p class="subtitle">100% private ‚Äî upload CSVs, tap Generate. Nothing leaves your phone.</p>

    <div class="upload-area">
        <div class="upload-grid">
            <div class="uc" id="ucStr" onclick="pick('strFile')">
                <label>üí™ Strength</label>
                <div class="fn" id="strName">strength_workouts.csv</div>
                <input type="file" id="strFile" accept=".csv" onchange="setLabel(this,'strName','ucStr')">
            </div>
            <div class="uc" id="ucWeight" onclick="pick('weightFile')">
                <label>‚öñÔ∏è Weight</label>
                <div class="fn" id="weightName">samsung weight.csv</div>
                <input type="file" id="weightFile" accept=".csv" onchange="setLabel(this,'weightName','ucWeight')">
            </div>
            <div class="uc" id="ucExercise" onclick="pick('exFile')">
                <label>üèãÔ∏è Exercise</label>
                <div class="fn" id="exName">samsung exercise.csv</div>
                <input type="file" id="exFile" accept=".csv" onchange="setLabel(this,'exName','ucExercise')">
            </div>
            <div class="uc" id="ucMfp" onclick="pick('mfpFile')">
                <label>ü•ó Nutrition</label>
                <div class="fn" id="mfpName">mfp_daily_calories.csv</div>
                <input type="file" id="mfpFile" accept=".csv" onchange="setLabel(this,'mfpName','ucMfp')">
            </div>
        </div>
        <div class="action-row">
            <button class="btn btn-go" onclick="loadAll()">‚ö° Generate Dashboard</button>
        </div>
        <div id="status-bar"></div>
    </div>

    <div id="dashboard"></div>

    <script>
        // ‚ïê‚ïê‚ïê PWA service worker ‚ïê‚ïê‚ïê
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => { });

        // ‚ïê‚ïê‚ïê UTIL ‚ïê‚ïê‚ïê
        const pick = id => document.getElementById(id).click();
        function setLabel(inp, id, ucId) {
            document.getElementById(id).textContent = inp.files[0]?.name || 'No file';
            if (ucId && inp.files[0]) document.getElementById(ucId).classList.add('loaded');
        }
        function readFile(inp) {
            return new Promise((res, rej) => {
                if (!inp.files[0]) return res(null);
                const r = new FileReader(); r.onload = e => res(e.target.result); r.onerror = rej; r.readAsText(inp.files[0]);
            });
        }
        function status(msg) { const b = document.getElementById('status-bar'); b.style.display = 'block'; b.textContent = msg; }

        function splitLine(line) {
            const r = []; let cur = '', q = false;
            for (const c of line) { if (c === '"') q = !q; else if (c === ',' && !q) { r.push(cur); cur = ''; } else cur += c; }
            r.push(cur); return r;
        }

        function parseCSV(text, skipSamsungMeta = false) {
            if (!text) return [];
            const lines = text.split('\n').filter(l => l.trim());
            let start = 0;
            if (skipSamsungMeta) {
                if (lines[0].replace(/\ufeff/, '').startsWith('com.samsung')) start = 1;
            }
            const rawHdrs = splitLine(lines[start]);
            const hdrs = rawHdrs.map(h => h.trim().replace(/^\ufeff/, '').replace(/"/g, ''));
            const rows = [];
            for (let i = start + 1; i < lines.length; i++) {
                const vals = splitLine(lines[i]); const row = {};
                hdrs.forEach((h, j) => { if (h) row[h] = (vals[j] || '').trim().replace(/"/g, ''); });
                rows.push(row);
            }
            return rows;
        }

        const fmt = d => d ? d.toISOString().slice(0, 10) : '';
        const pct = (a, b) => b && b !== 0 ? ((a - b) / b * 100).toFixed(1) : null;
        const avg = arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
        const sum = arr => arr.reduce((a, b) => a + b, 0);
        function movingAvg(data, w = 7) {
            return data.map((d, i) => {
                const s = Math.max(0, i - w + 1);
                return { x: d.x, y: Math.round(avg(data.slice(s, i + 1).map(v => v.y))) };
            });
        }

        // ‚ïê‚ïê‚ïê PARSERS ‚ïê‚ïê‚ïê
        function parseWeight(text) {
            if (!text) return [];
            const rows = parseCSV(text, true); const map = {};
            for (const r of rows) {
                const ts = r['start_time']; if (!ts) continue;
                const d = new Date(ts); if (isNaN(d)) continue;
                const key = fmt(d);
                const w = parseFloat(r['weight']); const bf = parseFloat(r['body_fat']);
                if (!isNaN(w) && w > 20 && w < 300) map[key] = { date: key, weight: w, bodyFat: !isNaN(bf) ? bf : null };
            }
            return Object.values(map).sort((a, b) => a.date.localeCompare(b.date));
        }

        const AUTO_DETECTED = new Set([0]);
        function parseExercise(text) {
            if (!text) return { exercise: [], meditation: [] };
            const rows = parseCSV(text, true); const exMap = {}, medMap = {};
            for (const r of rows) {
                const startCol = r['com.samsung.health.exercise.start_time'] || r['start_time'];
                if (!startCol) continue;
                const d = new Date(startCol); if (isNaN(d)) continue;
                const key = fmt(d);
                const exType = parseInt(r['com.samsung.health.exercise.exercise_type'] || r['exercise_type'] || '0');
                const customId = r['custom_id'];
                const dur = (parseFloat(r['com.samsung.health.exercise.duration'] || r['duration']) || 0) / 60000;
                const cal = parseFloat(r['com.samsung.health.exercise.calorie'] || r['calorie']) || 0;
                if (customId === 'm2u31389_1gq') {
                    if (!medMap[key]) medMap[key] = { date: key, min: 0 }; medMap[key].min += dur;
                } else if (!AUTO_DETECTED.has(exType)) {
                    if (!exMap[key]) exMap[key] = { date: key, min: 0, cal: 0 }; exMap[key].min += dur; exMap[key].cal += cal;
                }
            }
            return {
                exercise: Object.values(exMap).sort((a, b) => a.date.localeCompare(b.date)),
                meditation: Object.values(medMap).sort((a, b) => a.date.localeCompare(b.date))
            };
        }

        function parseStrength(text) {
            if (!text) return { byEx: {}, exercises: [], dailyVol: [] };
            const rows = parseCSV(text); const byEx = {}, dailyMap = {};
            for (const r of rows) {
                const ex = (r['Exercise'] || '').trim(); const date = (r['Date'] || '').trim();
                const weight = parseFloat(r['Weight']); const reps = parseFloat(r['Reps']) || 0;
                if (!ex || !date) continue;
                if (!isNaN(weight)) { if (!byEx[ex]) byEx[ex] = {}; if (!byEx[ex][date] || weight > byEx[ex][date]) byEx[ex][date] = weight; }
                if (!dailyMap[date]) dailyMap[date] = { date, sets: 0, vol: 0, exercises: new Set() };
                dailyMap[date].sets++; dailyMap[date].vol += reps * (isNaN(weight) ? 0 : weight); dailyMap[date].exercises.add(ex);
            }
            const exercises = Object.keys(byEx).sort((a, b) => Object.keys(byEx[b]).length - Object.keys(byEx[a]).length);
            const dailyVol = Object.values(dailyMap).map(d => ({ date: d.date, sets: d.sets, vol: Math.round(d.vol), exercises: d.exercises.size })).sort((a, b) => a.date.localeCompare(b.date));
            return { byEx, exercises, dailyVol };
        }

        function parseMFP(text) {
            if (!text) return [];
            const rows = parseCSV(text);
            return rows.map(r => ({
                date: r['Date'] || r['date'] || '', cal: parseFloat(r['MFP_Calories'] || r['Calories']) || 0,
                protein: parseFloat(r['Protein_g']) || 0, carbs: parseFloat(r['Carbs_g']) || 0,
                fat: parseFloat(r['Fat_g']) || 0, sugar: parseFloat(r['Sugar_g']) || 0, fiber: parseFloat(r['Fiber_g']) || 0,
            })).filter(r => r.date && r.cal > 50).sort((a, b) => a.date.localeCompare(b.date));
        }

        // ‚ïê‚ïê‚ïê CHART HELPERS ‚ïê‚ïê‚ïê
        const charts = {};
        function mkChart(id, cfg) {
            const el = document.getElementById(id); if (!el) return;
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(el.getContext('2d'), cfg);
        }
        const GRID = { color: 'rgba(255,255,255,0.04)' };
        const TICK = { color: '#64748b', font: { size: 9, family: 'Inter' } };
        const BASE = {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { labels: { color: '#94a3b8', font: { size: 9, family: 'Inter' }, boxWidth: 10, padding: 10 } },
                tooltip: { mode: 'index', intersect: false, backgroundColor: '#1a1e2a', titleColor: '#e2e8f0', bodyColor: '#94a3b8', borderColor: '#252a3a', borderWidth: 1, padding: 8, cornerRadius: 8 }
            }
        };
        function lineDS(label, data, color, fill = false, dash = false) {
            return { label, data, borderColor: color, backgroundColor: color + '18', borderWidth: 2, pointRadius: 1, pointHoverRadius: 4, tension: 0.35, fill, borderDash: dash ? [5, 3] : undefined };
        }
        function barDS(label, data, color) {
            return { label, data, backgroundColor: color + 'cc', borderColor: color, borderWidth: 0, borderRadius: 2, maxBarThickness: 10, minBarLength: 3 };
        }
        function timeX(unit = 'week') { return { type: 'time', time: { unit, tooltipFormat: 'MMM d, yyyy' }, grid: GRID, ticks: { ...TICK, maxTicksLimit: 8 } }; }
        function yAx(lbl, zero = false) {
            const ax = { grid: GRID, ticks: TICK, title: lbl ? { display: true, text: lbl, color: '#64748b', font: { size: 9, family: 'Inter' } } : undefined };
            if (zero) ax.min = 0; return ax;
        }
        const COLORS = ['#00e5ff', '#a78bfa', '#4ade80', '#fb923c', '#f472b6', '#facc15', '#38bdf8', '#f87171', '#34d399', '#c084fc', '#e879f9', '#a3e635'];

        // ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
        let G = { weights: [], exercise: [], meditation: [], str: null, mfp: [], ranges: { weight: 'all', nutrition: 'all', strength: 'all', meditation: 'all', cardio: 'all' } };

        // ‚ïê‚ïê‚ïê LOAD ‚ïê‚ïê‚ïê
        async function loadAll() {
            status('Reading files‚Ä¶');
            const [strText, weightText, exText, mfpText] = await Promise.all([
                readFile(document.getElementById('strFile')), readFile(document.getElementById('weightFile')),
                readFile(document.getElementById('exFile')), readFile(document.getElementById('mfpFile')),
            ]);
            status('Parsing‚Ä¶');
            G.weights = parseWeight(weightText);
            const exResult = parseExercise(exText); G.exercise = exResult.exercise; G.meditation = exResult.meditation;
            G.str = parseStrength(strText); G.mfp = parseMFP(mfpText);
            const parts = [];
            if (G.weights.length) parts.push(`${G.weights.length} weight`);
            if (G.exercise.length) parts.push(`${G.exercise.length} exercise`);
            if (G.meditation.length) parts.push(`${G.meditation.length} meditation`);
            if (G.str?.exercises.length) parts.push(`${G.str.exercises.length} exercises`);
            if (G.mfp.length) parts.push(`${G.mfp.length} nutrition`);
            status('‚úÖ ' + (parts.join(' ¬∑ ') || 'No data'));
            render();
        }

        function filterByRange(data, section, dateField = 'date') {
            const range = G.ranges[section]; if (range === 'all') return data;
            const now = new Date(); const months = range === '3m' ? 3 : range === '6m' ? 6 : 12;
            const cutoff = new Date(now.getFullYear(), now.getMonth() - months, now.getDate());
            return data.filter(r => (r[dateField] || r.date) >= fmt(cutoff));
        }

        function setRange(section, range) {
            G.ranges[section] = range;
            document.querySelectorAll(`.range-btn[data-section="${section}"]`).forEach(b => b.classList.toggle('active', b.dataset.range === range));
            if (section === 'weight') renderWeight();
            else if (section === 'nutrition') renderNutrition();
            else if (section === 'meditation') renderMeditation();
            else if (section === 'cardio') renderExercise();
            else if (section === 'strength') updateStrength();
        }

        function renderRangeBar(section) {
            const r = G.ranges[section];
            return `<div class="range-bar">
        <button class="range-btn${r === '3m' ? ' active' : ''}" data-section="${section}" data-range="3m" onclick="setRange('${section}','3m')">3M</button>
        <button class="range-btn${r === '6m' ? ' active' : ''}" data-section="${section}" data-range="6m" onclick="setRange('${section}','6m')">6M</button>
        <button class="range-btn${r === '1y' ? ' active' : ''}" data-section="${section}" data-range="1y" onclick="setRange('${section}','1y')">1Y</button>
        <button class="range-btn${r === 'all' ? ' active' : ''}" data-section="${section}" data-range="all" onclick="setRange('${section}','all')">All</button>
      </div>`;
        }

        // ‚ïê‚ïê‚ïê COLLAPSIBLE SECTIONS ‚ïê‚ïê‚ïê
        function toggleSection(el) {
            el.classList.toggle('collapsed');
            const body = el.nextElementSibling;
            if (body) body.classList.toggle('collapsed');
        }

        // ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê
        function render() {
            const dash = document.getElementById('dashboard'); const str = G.str;
            const hasWeight = G.weights.length > 0, hasMFP = G.mfp.length > 0;
            const hasMed = G.meditation.length > 0, hasStr = str && str.exercises.length > 0;
            const hasEx = G.exercise.length > 0;

            dash.innerHTML = `
        ${hasWeight ? `<h2 onclick="toggleSection(this)">‚öñÔ∏è Body Composition</h2>
        <div class="section-body">
        ${renderRangeBar('weight')}
        <div class="stats-grid" id="weightStats"></div>
        <div class="charts-grid" id="weightCharts"></div></div>` : ''}

        ${hasMFP ? `<h2 onclick="toggleSection(this)">ü•ó Nutrition</h2>
        <div class="section-body">
        ${renderRangeBar('nutrition')}
        <div class="stats-grid" id="nutritionStats"></div>
        <div class="charts-grid" id="nutritionCharts"></div></div>` : ''}

        ${hasStr ? `<h2 onclick="toggleSection(this)">üí™ Strength</h2>
        <div class="section-body">
        ${renderRangeBar('strength')}
        <div id="strCards" class="strength-cards"></div>
        <div class="ex-header">
          <span>${str.exercises.length} exercises</span>
          <button class="ex-clear" onclick="clearAll()">Clear</button>
          <button class="ex-clear" style="border-color:var(--accent3);color:var(--accent3)" onclick="selectTop5()">Top 5</button>
        </div>
        <div class="ex-selector" id="exSelector"></div>
        <div class="chart-card wide" style="margin-bottom:12px"><h3>Max Weight per Session (lbs)</h3><canvas id="strengthChart" height="50"></canvas></div>
        <div class="charts-grid" id="strCharts"></div></div>` : ''}

        ${hasMed ? `<h2 onclick="toggleSection(this)">üßò Meditation</h2>
        <div class="section-body">
        ${renderRangeBar('meditation')}
        <div class="stats-grid" id="medStats"></div>
        <div class="charts-grid" id="medCharts"></div></div>` : ''}

        ${hasEx ? `<h2 onclick="toggleSection(this)">üèÉ Cardio</h2>
        <div class="section-body">
        ${renderRangeBar('cardio')}
        <div class="stats-grid" id="exStats"></div>
        <div class="charts-grid" id="exCharts"></div></div>` : ''}
      `;

            if (hasStr) {
                const sel = document.getElementById('exSelector');
                str.exercises.forEach(ex => {
                    const btn = document.createElement('button'); btn.className = 'ex-btn';
                    btn.textContent = ex.length > 22 ? ex.slice(0, 20) + '‚Ä¶' : ex;
                    btn.title = ex; btn.dataset.ex = ex;
                    btn.addEventListener('click', () => { btn.classList.toggle('active'); updateStrength(); });
                    sel.appendChild(btn);
                });
                selectTop5();
            }
            renderSections();
        }

        function renderSections() { renderWeight(); renderNutrition(); renderMeditation(); renderExercise(); if (G.str?.exercises.length) updateStrength(); }

        // ‚îÄ‚îÄ Weight ‚îÄ‚îÄ
        function renderWeight() {
            const d = filterByRange(G.weights, 'weight'); if (!d.length) return;
            const latest = d[d.length - 1], first = d[0];
            const change = (latest.weight - first.weight).toFixed(1);
            const hasBF = d.some(r => r.bodyFat !== null);
            const latestBF = hasBF ? d.filter(r => r.bodyFat !== null).pop() : null;
            const statsDiv = document.getElementById('weightStats');
            if (statsDiv) {
                statsDiv.innerHTML = `
          <div class="stat-card"><div class="s-lbl">Latest</div><div class="s-val" style="color:var(--accent2)">${latest.weight.toFixed(1)}</div><div class="s-unit">kg</div></div>
          <div class="stat-card"><div class="s-lbl">Change</div><div class="s-val"><span class="${parseFloat(change) <= 0 ? 'pos' : 'neg'}">${change}</span></div><div class="s-unit">kg</div></div>
          <div class="stat-card"><div class="s-lbl">Readings</div><div class="s-val" style="color:var(--accent)">${d.length}</div></div>
          ${latestBF ? `<div class="stat-card"><div class="s-lbl">Body Fat</div><div class="s-val" style="color:var(--accent4)">${latestBF.bodyFat.toFixed(1)}%</div></div>` : ''}
        `;
            }
            const chartsDiv = document.getElementById('weightCharts'); if (!chartsDiv) return;
            chartsDiv.innerHTML = `<div class="chart-card wide"><h3>Weight (kg)</h3><canvas id="weightChart"></canvas></div>
        ${hasBF ? `<div class="chart-card wide"><h3>Body Fat %</h3><canvas id="bfChart"></canvas></div>` : ''}`;
            const tu = d.length > 365 ? 'month' : d.length > 60 ? 'week' : 'day';
            mkChart('weightChart', { type: 'line', data: { datasets: [lineDS('Weight', d.map(r => ({ x: r.date, y: r.weight })), '#a78bfa', true)] }, options: { ...BASE, scales: { x: timeX(tu), y: yAx('kg') } } });
            if (hasBF) {
                const bfData = d.filter(r => r.bodyFat !== null).map(r => ({ x: r.date, y: r.bodyFat }));
                if (bfData.length) mkChart('bfChart', { type: 'line', data: { datasets: [lineDS('Body Fat', bfData, '#fb923c', true)] }, options: { ...BASE, scales: { x: timeX(tu), y: yAx('%') } } });
            }
        }

        // ‚îÄ‚îÄ Nutrition ‚îÄ‚îÄ
        function renderNutrition() {
            const d = filterByRange(G.mfp, 'nutrition'); if (!d.length) return;
            const avgCal = Math.round(avg(d.map(r => r.cal))), avgProt = Math.round(avg(d.map(r => r.protein)));
            const avgCarbs = Math.round(avg(d.map(r => r.carbs))), avgFat = Math.round(avg(d.map(r => r.fat)));
            const statsDiv = document.getElementById('nutritionStats');
            if (statsDiv) {
                statsDiv.innerHTML = `
          <div class="stat-card"><div class="s-lbl">Avg Cal</div><div class="s-val" style="color:var(--accent4)">${avgCal.toLocaleString()}</div><div class="s-unit">kcal/day</div></div>
          <div class="stat-card"><div class="s-lbl">Protein</div><div class="s-val" style="color:var(--accent)">${avgProt}g</div></div>
          <div class="stat-card"><div class="s-lbl">Carbs</div><div class="s-val" style="color:var(--accent3)">${avgCarbs}g</div></div>
          <div class="stat-card"><div class="s-lbl">Fat</div><div class="s-val" style="color:var(--accent5)">${avgFat}g</div></div>
        `;
            }
            const chartsDiv = document.getElementById('nutritionCharts'); if (!chartsDiv) return;
            chartsDiv.innerHTML = `
        <div class="chart-card wide"><h3>Daily Calories (7d avg)</h3><canvas id="calChart"></canvas></div>
        <div class="chart-card"><h3>Protein (g/day)</h3><canvas id="protChart"></canvas></div>
        <div class="chart-card"><h3>Macro Split</h3><canvas id="macroChart"></canvas></div>
      `;
            const calData = d.map(r => ({ x: r.date, y: r.cal }));
            mkChart('calChart', { type: 'line', data: { datasets: [barDS('Daily', calData, '#fb923c'), lineDS('7d Avg', movingAvg(calData), '#fb923c')] }, options: { ...BASE, scales: { x: timeX(), y: yAx('kcal', true) } } });
            const protData = d.map(r => ({ x: r.date, y: r.protein }));
            mkChart('protChart', { type: 'line', data: { datasets: [lineDS('Protein', protData, '#00e5ff', true), lineDS('7d Avg', movingAvg(protData), '#00e5ff', false, true)] }, options: { ...BASE, scales: { x: timeX(), y: yAx('g', true) } } });
            mkChart('macroChart', {
                type: 'doughnut',
                data: { labels: ['Protein', 'Carbs', 'Fat'], datasets: [{ data: [avgProt * 4, avgCarbs * 4, avgFat * 9], backgroundColor: ['#00e5ff', '#4ade80', '#f472b6'], borderWidth: 0 }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 10 }, padding: 12 } }, tooltip: { callbacks: { label: ctx => { const t = ctx.dataset.data.reduce((a, b) => a + b, 0); return `${ctx.label}: ${((ctx.raw / t) * 100).toFixed(0)}% (${[avgProt, avgCarbs, avgFat][ctx.dataIndex]}g)`; } } } } }
            });
        }

        // ‚îÄ‚îÄ Meditation ‚îÄ‚îÄ
        function renderMeditation() {
            const d = filterByRange(G.meditation, 'meditation'); if (!d.length) return;
            const totalMin = Math.round(sum(d.map(r => r.min))), avgMin = Math.round(avg(d.map(r => r.min)));
            const streak = calcStreak(d);
            const statsDiv = document.getElementById('medStats');
            if (statsDiv) {
                statsDiv.innerHTML = `
          <div class="stat-card"><div class="s-lbl">Sessions</div><div class="s-val" style="color:var(--accent2)">${d.length}</div></div>
          <div class="stat-card"><div class="s-lbl">Total</div><div class="s-val" style="color:var(--accent2)">${(totalMin / 60).toFixed(1)}</div><div class="s-unit">hours</div></div>
          <div class="stat-card"><div class="s-lbl">Avg</div><div class="s-val" style="color:var(--accent2)">${avgMin}</div><div class="s-unit">min</div></div>
          <div class="stat-card"><div class="s-lbl">Streak</div><div class="s-val" style="color:var(--accent3)">${streak}</div><div class="s-unit">days</div></div>
        `;
            }
            const chartsDiv = document.getElementById('medCharts'); if (!chartsDiv) return;
            chartsDiv.innerHTML = `<div class="chart-card wide"><h3>Daily Meditation (min)</h3><canvas id="medChart"></canvas></div>`;
            mkChart('medChart', { type: 'bar', data: { datasets: [barDS('Minutes', d.map(r => ({ x: r.date, y: Math.round(r.min) })), '#a78bfa')] }, options: { ...BASE, scales: { x: timeX(), y: yAx('min', true) } } });
        }

        function calcStreak(data) {
            if (!data.length) return 0; let max = 1, cur = 1;
            for (let i = 1; i < data.length; i++) {
                const diff = (new Date(data[i].date + 'T12:00:00') - new Date(data[i - 1].date + 'T12:00:00')) / 86400000;
                if (diff === 1) { cur++; if (cur > max) max = cur; } else cur = 1;
            }
            return max;
        }

        // ‚îÄ‚îÄ Cardio ‚îÄ‚îÄ
        function renderExercise() {
            const d = filterByRange(G.exercise, 'cardio'); if (!d.length) return;
            const totalMin = Math.round(sum(d.map(r => r.min)));
            const statsDiv = document.getElementById('exStats');
            if (statsDiv) {
                statsDiv.innerHTML = `
          <div class="stat-card"><div class="s-lbl">Days</div><div class="s-val" style="color:var(--accent3)">${d.length}</div></div>
          <div class="stat-card"><div class="s-lbl">Total</div><div class="s-val" style="color:var(--accent3)">${(totalMin / 60).toFixed(0)}</div><div class="s-unit">hours</div></div>
          <div class="stat-card"><div class="s-lbl">Avg</div><div class="s-val" style="color:var(--accent3)">${Math.round(avg(d.map(r => r.min)))}</div><div class="s-unit">min</div></div>
        `;
            }
            const chartsDiv = document.getElementById('exCharts'); if (!chartsDiv) return;
            chartsDiv.innerHTML = `<div class="chart-card wide"><h3>Cardio (min/day)</h3><canvas id="exChart"></canvas></div>`;
            mkChart('exChart', { type: 'bar', data: { datasets: [barDS('Minutes', d.map(r => ({ x: r.date, y: Math.round(r.min) })), '#4ade80')] }, options: { ...BASE, scales: { x: timeX(), y: yAx('min', true) } } });
        }

        // ‚îÄ‚îÄ Strength ‚îÄ‚îÄ
        function selectTop5(doUpdate = true) { document.querySelectorAll('.ex-btn').forEach((b, i) => b.classList.toggle('active', i < 5)); if (doUpdate) updateStrength(); }
        function clearAll() { document.querySelectorAll('.ex-btn').forEach(b => b.classList.remove('active')); updateStrength(); }

        function updateStrength() {
            const selected = Array.from(document.querySelectorAll('.ex-btn.active')).map(b => b.dataset.ex);
            const str = G.str; const cards = document.getElementById('strCards');
            if (!cards) return;
            if (!selected.length) { cards.innerHTML = '<div class="empty-hint"><div class="icon">üëÜ</div>Select exercises</div>'; if (charts['strengthChart']) charts['strengthChart'].destroy(); return; }
            cards.innerHTML = '';
            selected.forEach((ex, idx) => {
                let sessions = Object.entries(str.byEx[ex] || {}).sort((a, b) => a[0].localeCompare(b[0]));
                sessions = filterByRange(sessions.map(([d, w]) => ({ date: d, w })), 'strength');
                if (!sessions.length) return;
                const maxAll = Math.max(...sessions.map(s => s.w));
                const first = sessions[0].w, recent = sessions[sessions.length - 1].w;
                const prog = pct(recent, first); const color = COLORS[idx % COLORS.length];
                const card = document.createElement('div'); card.className = 's-card';
                card.innerHTML = `<div class="ex-name" title="${ex}" style="color:${color}">${ex}</div>
          <div class="ex-max" style="color:${color}">${maxAll}</div><div class="ex-unit">lbs max</div>
          <div class="ex-meta">Start: ${first} ‚Üí Recent: ${recent}<br>
          <span class="${prog !== null && parseFloat(prog) >= 0 ? 'pos' : 'neg'}">${prog !== null ? (parseFloat(prog) >= 0 ? '+' : '') + prog + '%' : '‚Äî'}</span></div>`;
                cards.appendChild(card);
            });
            const datasets = selected.map((ex, idx) => {
                let sessions = Object.entries(str.byEx[ex] || {}).sort((a, b) => a[0].localeCompare(b[0]));
                sessions = filterByRange(sessions.map(([d, w]) => ({ date: d, w })), 'strength');
                const color = COLORS[idx % COLORS.length];
                return lineDS(ex.length > 18 ? ex.slice(0, 16) + '‚Ä¶' : ex, sessions.map(s => ({ x: s.date, y: s.w })), color);
            });
            mkChart('strengthChart', { type: 'line', data: { datasets }, options: { ...BASE, scales: { x: timeX(), y: yAx('lbs') } } });
            const strCharts = document.getElementById('strCharts');
            if (strCharts) {
                strCharts.innerHTML = `
          <div class="chart-card"><h3>Volume (lbs)</h3><canvas id="volumeChart"></canvas></div>
          <div class="chart-card"><h3>Sets/Day</h3><canvas id="setsChart"></canvas></div>
        `;
                const dv = filterByRange(str.dailyVol, 'strength');
                if (dv.length) {
                    mkChart('volumeChart', { type: 'bar', data: { datasets: [barDS('Volume', dv.map(r => ({ x: r.date, y: r.vol })), '#4ade80')] }, options: { ...BASE, scales: { x: timeX(), y: yAx('lbs', true) } } });
                    mkChart('setsChart', { type: 'bar', data: { datasets: [barDS('Sets', dv.map(r => ({ x: r.date, y: r.sets })), '#38bdf8')] }, options: { ...BASE, scales: { x: timeX(), y: yAx('sets', true) } } });
                }
            }
        }

        // ‚ïê‚ïê‚ïê ORIENTATION CHANGE ‚ïê‚ïê‚ïê
        window.addEventListener('orientationchange', () => {
            setTimeout(() => { Object.values(charts).forEach(c => c?.resize()); }, 300);
        });
        window.addEventListener('resize', () => { Object.values(charts).forEach(c => c?.resize()); });

        // Initial
        document.getElementById('dashboard').innerHTML = `<div class="empty-hint"><div class="icon">üìä</div><p>Upload your files and tap <strong>‚ö° Generate Dashboard</strong></p></div>`;
    </script>
</body>

</html>